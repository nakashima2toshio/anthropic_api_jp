# üìã a05_conversation_state.py Ë®≠Ë®àÊõ∏

## üìù ÁõÆÊ¨°

1. [üìñ Ê¶ÇË¶ÅÊõ∏](#üìñ-Ê¶ÇË¶ÅÊõ∏)
2. [üîß „Ç∑„Çπ„ÉÜ„É†ÊßãÊàê](#üîß-„Ç∑„Çπ„ÉÜ„É†ÊßãÊàê)
3. [üìã Èñ¢Êï∞‰∏ÄË¶ß](#üìã-Èñ¢Êï∞‰∏ÄË¶ß)
4. [üìë Èñ¢Êï∞Ë©≥Á¥∞Ë®≠Ë®à](#üìë-Èñ¢Êï∞Ë©≥Á¥∞Ë®≠Ë®à)
5. [‚öôÔ∏è ÊäÄË°ì‰ªïÊßò](#‚öôÔ∏è-ÊäÄË°ì‰ªïÊßò)
6. [üö® „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞](#üö®-„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞)

---

## üìñ Ê¶ÇË¶ÅÊõ∏

### üéØ Âá¶ÁêÜ„ÅÆÊ¶ÇË¶Å

**‰ºöË©±Áä∂ÊÖãÁÆ°ÁêÜ„Éª„ÉÑ„Éº„É´‰ΩøÁî®„Éá„É¢„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥**

Êú¨„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅØ„ÄÅAnthropic Claude API„Çí‰ΩøÁî®„Åó„ÅüÁä∂ÊÖãÁÆ°ÁêÜÂûã„ÅÆ‰ºöË©±„Ç∑„Çπ„ÉÜ„É†„Å®„ÄÅ„ÉÑ„Éº„É´‰ΩøÁî®ÔºàFunction CallingÔºâÊ©üËÉΩ„ÇíÂÆüË£Ö„Åó„ÅüStreamlit Web„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Åß„Åô„ÄÇ‰ºöË©±„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„ÅÆ‰øùÊåÅ„ÄÅ„Éï„Ç©„É≠„Éº„Ç¢„ÉÉ„ÉóË≥™Âïè„Å∏„ÅÆÂØæÂøú„ÄÅÂ§ñÈÉ®API„Å®„ÅÆÈÄ£Êê∫„ÇíÈÄö„Åò„Å¶„ÄÅÈ´òÂ∫¶„Å™ÂØæË©±„Ç∑„Çπ„ÉÜ„É†„ÇíÂÆüÁèæ„Åó„Åæ„Åô„ÄÇ

#### üåü ‰∏ªË¶ÅÊ©üËÉΩ

| Ê©üËÉΩ | Ë™¨Êòé |
|------|------|
| üí¨ **Áä∂ÊÖãÁ∂≠ÊåÅ‰ºöË©±** | ‰ºöË©±Â±•Ê≠¥„Çí‰øùÊåÅ„Åó„ÅüÊñáËÑàË™çË≠òÂØæË©± |
| üîß **„ÉÑ„Éº„É´‰ΩøÁî®** | „Ç´„Çπ„Çø„É†„ÉÑ„Éº„É´ÂÆöÁæ©„Å®ÂÆüË°å |
| üå§Ô∏è **Èñ¢Êï∞Âëº„Å≥Âá∫„Åó** | Â§©Ê∞óAPI„Å™„Å©Â§ñÈÉ®„Çµ„Éº„Éì„ÇπÈÄ£Êê∫ |
| üìä **ÊßãÈÄ†ÂåñÂá∫Âäõ** | „ÉÑ„Éº„É´ÂºïÊï∞„ÅÆÂûãÂÆâÂÖ®„Å™Âá¶ÁêÜ |
| üîÑ **„Éï„Ç©„É≠„Éº„Ç¢„ÉÉ„Éó** | ÊñáËÑà„ÇíËÄÉÊÖÆ„Åó„ÅüÈÄ£Á∂öË≥™ÂïèÂØæÂøú |

#### üé® Âá¶ÁêÜÂØæË±°„Éá„Éº„Çø

```mermaid
graph LR
    A["User Query"] --> B{Context Type}
    B -->|Stateful| C["Add to History"]
    B -->|Tool Use| D["Tool Selection"]
    B -->|Function| E["Function Call"]
    
    C --> F["Context-Aware Response"]
    D --> G["Tool Execution"]
    E --> H["API Integration"]
    
    F --> I["Update State"]
    G --> I
    H --> I
```

### üîÑ main„ÅÆÂá¶ÁêÜ„ÅÆÊµÅ„Çå

```mermaid
flowchart TD
    Start(["App Start"]) --> Config["Page Config Setup"]
    Config --> Import["Import Validation"]
    Import --> ApiKey["API Key Check"]
    ApiKey --> Manager["DemoManager Init"]
    
    Manager --> UI["Setup UI"]
    UI --> DemoSelect["Demo Selection"]
    
    DemoSelect --> Type{Demo Type}
    Type -->|Stateful| State["Load Conversation History"]
    Type -->|Tool| Tool["Define Tools"]
    Type -->|Function| Func["Setup Functions"]
    
    State --> Conv["Conversation Loop"]
    Tool --> Exec["Tool Execution"]
    Func --> Call["Function Call"]
    
    Conv --> Update["Update History"]
    Exec --> Update
    Call --> Update
    
    Update --> Display["Display Response"]
    Display --> DemoSelect
```

---

## üîß „Ç∑„Çπ„ÉÜ„É†ÊßãÊàê

### üì¶ ‰∏ªË¶Å„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà

```mermaid
classDiagram
    class BaseDemo {
        <<abstract>>
        +string demo_name
        +AnthropicClient client
        +run()
        +error_handler_ui()
        +timer_ui()
    }

    class StatefulConversationDemo {
        +run()
        +manage_conversation_history()
        +add_message()
        +get_context()
        +handle_followup()
    }

    class ToolUseDemo {
        +run()
        +define_tools()
        +execute_tool()
        +parse_tool_response()
        +format_tool_result()
    }

    class FunctionCallingDemo {
        +run()
        +get_weather()
        +define_weather_function()
        +call_weather_api()
        +format_weather_response()
    }

    class DemoManager {
        +dict demos
        +run_application()
        +setup_sidebar()
        +manage_session_state()
    }

    class ConversationManager {
        <<utility>>
        +List messages
        +add_user_message()
        +add_assistant_message()
        +get_full_history()
        +clear_history()
    }

    class ToolManager {
        <<utility>>
        +dict tools
        +register_tool()
        +get_tool_schema()
        +validate_arguments()
    }

    class WeatherAPI {
        <<external>>
        +fetch_weather()
        +parse_response()
    }

    BaseDemo <|-- StatefulConversationDemo
    BaseDemo <|-- ToolUseDemo
    BaseDemo <|-- FunctionCallingDemo
    
    StatefulConversationDemo --> ConversationManager
    ToolUseDemo --> ToolManager
    FunctionCallingDemo --> WeatherAPI
    
    DemoManager --> BaseDemo
```

### üìã „Éá„Éº„Çø„Éï„É≠„Éº

```mermaid
graph TD
    A["User Input"] --> B{Demo Type}
    
    B -->|Stateful| C["Check History"]
    C --> D["Add to Context"]
    D --> E["API Call with History"]
    E --> F["Get Response"]
    F --> G["Update History"]
    
    B -->|Tool| H["Parse for Tool Need"]
    H --> I["Select Tool"]
    I --> J["Extract Arguments"]
    J --> K["Execute Tool"]
    K --> L["Format Result"]
    
    B -->|Function| M["Identify Function"]
    M --> N["Validate Parameters"]
    N --> O["Call External API"]
    O --> P["Process Response"]
    
    G --> Q["Display"]
    L --> Q
    P --> Q
    
    Q --> R["Session Update"]
```

---

## üìã Èñ¢Êï∞‰∏ÄË¶ß

### üèóÔ∏è „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Âà∂Âæ°Èñ¢Êï∞

| Èñ¢Êï∞Âêç | ÂàÜÈ°û | Âá¶ÁêÜÊ¶ÇË¶Å | ÈáçË¶ÅÂ∫¶ |
|--------|------|----------|---------|
| `main()` | üéØ Âà∂Âæ° | „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Ç®„É≥„Éà„É™„Éº„Éù„Ç§„É≥„Éà | ‚≠ê‚≠ê‚≠ê |
| `DemoManager.__init__()` | üîß ÂàùÊúüÂåñ | „Éá„É¢„Éû„Éç„Éº„Ç∏„É£„ÉºÂàùÊúüÂåñ | ‚≠ê‚≠ê‚≠ê |
| `DemoManager.run_application()` | üéØ Âà∂Âæ° | „Éá„É¢Áµ±ÂêàÁÆ°ÁêÜ„ÉªÂÆüË°åÂà∂Âæ° | ‚≠ê‚≠ê‚≠ê |
| `DemoManager.setup_sidebar()` | üé® UI | „Çµ„Ç§„Éâ„Éê„ÉºË®≠ÂÆö„Éª„Éá„É¢ÈÅ∏Êäû | ‚≠ê‚≠ê‚≠ê |

### üí¨ ‰ºöË©±Áä∂ÊÖãÁÆ°ÁêÜÈñ¢Êï∞

| Èñ¢Êï∞Âêç | ÂàÜÈ°û | Âá¶ÁêÜÊ¶ÇË¶Å | ÈáçË¶ÅÂ∫¶ |
|--------|------|----------|---------|
| `StatefulConversationDemo.run()` | üéØ ÂÆüË°å | Áä∂ÊÖãÁ∂≠ÊåÅ‰ºöË©±„Éá„É¢ÂÆüË°å | ‚≠ê‚≠ê‚≠ê |
| `StatefulConversationDemo.manage_conversation_history()` | üìù ÁÆ°ÁêÜ | ‰ºöË©±Â±•Ê≠¥ÁÆ°ÁêÜ | ‚≠ê‚≠ê‚≠ê |
| `StatefulConversationDemo.add_message()` | ‚ûï ËøΩÂä† | „É°„ÉÉ„Çª„Éº„Ç∏Â±•Ê≠¥ËøΩÂä† | ‚≠ê‚≠ê |
| `StatefulConversationDemo.get_context()` | üìñ ÂèñÂæó | „Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàÂèñÂæó | ‚≠ê‚≠ê |
| `StatefulConversationDemo.handle_followup()` | üîÑ Âá¶ÁêÜ | „Éï„Ç©„É≠„Éº„Ç¢„ÉÉ„ÉóË≥™ÂïèÂá¶ÁêÜ | ‚≠ê‚≠ê‚≠ê |

### üîß „ÉÑ„Éº„É´‰ΩøÁî®Èñ¢Êï∞

| Èñ¢Êï∞Âêç | ÂàÜÈ°û | Âá¶ÁêÜÊ¶ÇË¶Å | ÈáçË¶ÅÂ∫¶ |
|--------|------|----------|---------|
| `ToolUseDemo.run()` | üéØ ÂÆüË°å | „ÉÑ„Éº„É´‰ΩøÁî®„Éá„É¢ÂÆüË°å | ‚≠ê‚≠ê‚≠ê |
| `ToolUseDemo.define_tools()` | üìù ÂÆöÁæ© | „ÉÑ„Éº„É´„Çπ„Ç≠„Éº„ÉûÂÆöÁæ© | ‚≠ê‚≠ê‚≠ê |
| `ToolUseDemo.execute_tool()` | ‚ö° ÂÆüË°å | „ÉÑ„Éº„É´ÂÆüË°åÂá¶ÁêÜ | ‚≠ê‚≠ê‚≠ê |
| `ToolUseDemo.parse_tool_response()` | üîç Ëß£Êûê | „ÉÑ„Éº„É´ÂøúÁ≠îËß£Êûê | ‚≠ê‚≠ê |
| `ToolUseDemo.format_tool_result()` | üìã Êï¥ÂΩ¢ | „ÉÑ„Éº„É´ÁµêÊûúÊï¥ÂΩ¢ | ‚≠ê |

### üå§Ô∏è Èñ¢Êï∞Âëº„Å≥Âá∫„ÅóÈñ¢Êï∞

| Èñ¢Êï∞Âêç | ÂàÜÈ°û | Âá¶ÁêÜÊ¶ÇË¶Å | ÈáçË¶ÅÂ∫¶ |
|--------|------|----------|---------|
| `FunctionCallingDemo.run()` | üéØ ÂÆüË°å | Èñ¢Êï∞Âëº„Å≥Âá∫„Åó„Éá„É¢ÂÆüË°å | ‚≠ê‚≠ê‚≠ê |
| `FunctionCallingDemo.get_weather()` | üå§Ô∏è API | Â§©Ê∞óÊÉÖÂ†±ÂèñÂæó | ‚≠ê‚≠ê‚≠ê |
| `FunctionCallingDemo.define_weather_function()` | üìù ÂÆöÁæ© | Â§©Ê∞óÈñ¢Êï∞ÂÆöÁæ© | ‚≠ê‚≠ê |
| `FunctionCallingDemo.call_weather_api()` | üîå ÂëºÂá∫ | Â§ñÈÉ®APIÂëº„Å≥Âá∫„Åó | ‚≠ê‚≠ê‚≠ê |
| `FunctionCallingDemo.format_weather_response()` | üìã Êï¥ÂΩ¢ | Â§©Ê∞ó„Éá„Éº„ÇøÊï¥ÂΩ¢ | ‚≠ê |

---

## üìë Èñ¢Êï∞Ë©≥Á¥∞Ë®≠Ë®à

### üí¨ StatefulConversationDemo.run()

#### üéØ Âá¶ÁêÜÊ¶ÇË¶Å
‰ºöË©±Â±•Ê≠¥„Çí‰øùÊåÅ„Åó„ÅüÁä∂ÊÖãÁÆ°ÁêÜÂûã„ÅÆÂØæË©±„Éá„É¢

#### üìä Âá¶ÁêÜ„ÅÆÊµÅ„Çå
```mermaid
graph TD
    A["Demo Start"] --> B["Load Session History"]
    B --> C["Display Conversation"]
    C --> D["User Input"]
    D --> E{"New Message?"}
    E -->|No| F["Wait"]
    E -->|Yes| G["Add to History"]
    G --> H["Build Context"]
    H --> I["API Call with Context"]
    I --> J["Get Response"]
    J --> K["Add Response to History"]
    K --> L["Update Display"]
    L --> M{"Continue?"}
    M -->|Yes| D
    M -->|No| N["Save Session"]
```

#### üìã IPOË®≠Ë®à

| È†ÖÁõÆ | ÂÜÖÂÆπ |
|------|------|
| **INPUT** | „É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÄÅ‰ºöË©±Â±•Ê≠¥„ÄÅ„É¢„Éá„É´Ë®≠ÂÆö |
| **PROCESS** | Â±•Ê≠¥ÁÆ°ÁêÜ ‚Üí „Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàÊßãÁØâ ‚Üí APIÂëº„Å≥Âá∫„Åó ‚Üí Â±•Ê≠¥Êõ¥Êñ∞ |
| **OUTPUT** | „Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàËÄÉÊÖÆÊ∏à„ÅøÂøúÁ≠î„ÄÅÊõ¥Êñ∞Ê∏à„Åø‰ºöË©±Â±•Ê≠¥ |

---

### üîß ToolUseDemo.run()

#### üéØ Âá¶ÁêÜÊ¶ÇË¶Å
„Ç´„Çπ„Çø„É†„ÉÑ„Éº„É´ÂÆöÁæ©„Å®ÂÆüË°å„ÇíË°å„ÅÜ„Éá„É¢

#### üìä Âá¶ÁêÜ„ÅÆÊµÅ„Çå
```mermaid
graph TD
    A["Demo Start"] --> B["Define Tools"]
    B --> C["Display Tool Info"]
    C --> D["User Query"]
    D --> E["API Call with Tools"]
    E --> F{"Tool Needed?"}
    F -->|No| G["Text Response"]
    F -->|Yes| H["Extract Tool Call"]
    H --> I["Parse Arguments"]
    I --> J["Execute Tool"]
    J --> K["Get Tool Result"]
    K --> L["Format Response"]
    G --> M["Display"]
    L --> M
```

#### üìã IPOË®≠Ë®à

| È†ÖÁõÆ | ÂÜÖÂÆπ |
|------|------|
| **INPUT** | „É¶„Éº„Ç∂„Éº„ÇØ„Ç®„É™„ÄÅ„ÉÑ„Éº„É´ÂÆöÁæ©„ÄÅÂÆüË°å„Éë„É©„É°„Éº„Çø |
| **PROCESS** | „ÉÑ„Éº„É´ÈÅ∏Êäû ‚Üí ÂºïÊï∞ÊäΩÂá∫ ‚Üí „ÉÑ„Éº„É´ÂÆüË°å ‚Üí ÁµêÊûúÊï¥ÂΩ¢ |
| **OUTPUT** | „ÉÑ„Éº„É´ÂÆüË°åÁµêÊûú„ÄÅÊßãÈÄ†ÂåñÂøúÁ≠î |

#### üíª „ÉÑ„Éº„É´ÂÆöÁæ©‰æã

```python
tools = [
    {
        "name": "get_weather",
        "description": "Get weather information for a location",
        "input_schema": {
            "type": "object",
            "properties": {
                "location": {
                    "type": "string",
                    "description": "City name"
                },
                "units": {
                    "type": "string",
                    "enum": ["celsius", "fahrenheit"]
                }
            },
            "required": ["location"]
        }
    }
]
```

---

### üå§Ô∏è FunctionCallingDemo.run()

#### üéØ Âá¶ÁêÜÊ¶ÇË¶Å
Â§ñÈÉ®APIÔºàÂ§©Ê∞óÊÉÖÂ†±Ôºâ„Å®ÈÄ£Êê∫„Åô„ÇãÈñ¢Êï∞Âëº„Å≥Âá∫„Åó„Éá„É¢

#### üìä Âá¶ÁêÜ„ÅÆÊµÅ„Çå
```mermaid
graph TD
    A["Demo Start"] --> B["Setup Weather Function"]
    B --> C["User Location Input"]
    C --> D["Validate Input"]
    D --> E["Build Function Call"]
    E --> F["API Request with Function"]
    F --> G{"Function Called?"}
    G -->|No| H["Direct Response"]
    G -->|Yes| I["Extract Location"]
    I --> J["Call Weather API"]
    J --> K{"API Success?"}
    K -->|No| L["Error Handling"]
    K -->|Yes| M["Parse Weather Data"]
    M --> N["Format Response"]
    H --> O["Display"]
    L --> O
    N --> O
```

#### üìã IPOË®≠Ë®à

| È†ÖÁõÆ | ÂÜÖÂÆπ |
|------|------|
| **INPUT** | ÈÉΩÂ∏ÇÂêç„ÄÅÂçò‰ΩçË®≠ÂÆöÔºàÊëÇÊ∞è/ËèØÊ∞èÔºâ |
| **PROCESS** | Èñ¢Êï∞ÂÆöÁæ© ‚Üí APIÂëº„Å≥Âá∫„Åó ‚Üí Â§©Ê∞ó„Éá„Éº„ÇøÂèñÂæó ‚Üí ÁµêÊûúÊï¥ÂΩ¢ |
| **OUTPUT** | Â§©Ê∞óÊÉÖÂ†±ÔºàÊ∏©Â∫¶„ÄÅÊπøÂ∫¶„ÄÅÂ§©ÂÄô„ÄÅ‰∫àÂ†±Ôºâ |

---

### üìù manage_conversation_history()

#### üéØ Âá¶ÁêÜÊ¶ÇË¶Å
‰ºöË©±Â±•Ê≠¥„ÅÆÁÆ°ÁêÜ„Å®ÊñáËÑàÊßãÁØâ

#### üìä Âá¶ÁêÜ„ÅÆÊµÅ„Çå
```mermaid
graph TD
    A["Function Start"] --> B["Get Session State"]
    B --> C{"History Exists?"}
    C -->|No| D["Initialize History"]
    C -->|Yes| E["Load History"]
    D --> F["Set Max Length"]
    E --> F
    F --> G["Check Length"]
    G --> H{"Too Long?"}
    H -->|Yes| I["Truncate Old Messages"]
    H -->|No| J["Keep All"]
    I --> K["Return History"]
    J --> K
```

#### üìã IPOË®≠Ë®à

| È†ÖÁõÆ | ÂÜÖÂÆπ |
|------|------|
| **INPUT** | „Çª„ÉÉ„Ç∑„Éß„É≥Áä∂ÊÖã„ÄÅÊúÄÂ§ßÂ±•Ê≠¥Èï∑ |
| **PROCESS** | Â±•Ê≠¥ÂèñÂæó ‚Üí Èï∑„ÅïÁ¢∫Ë™ç ‚Üí ÂøÖË¶Å„Å´Âøú„Åò„Å¶Âàá„ÇäË©∞„ÇÅ |
| **OUTPUT** | ÁÆ°ÁêÜÊ∏à„Åø‰ºöË©±Â±•Ê≠¥ÈÖçÂàó |

---

## ‚öôÔ∏è ÊäÄË°ì‰ªïÊßò

### üì¶ ‰æùÂ≠ò„É©„Ç§„Éñ„É©„É™

| „É©„Ç§„Éñ„É©„É™ | „Éê„Éº„Ç∏„Éß„É≥ | Áî®ÈÄî | ÈáçË¶ÅÂ∫¶ |
|-----------|-----------|------|---------|
| `streamlit` | ÊúÄÊñ∞ | üé® Web UI„Éï„É¨„Éº„É†„ÉØ„Éº„ÇØ | ‚≠ê‚≠ê‚≠ê |
| `anthropic` | ÊúÄÊñ∞ | ü§ñ Anthropic Claude API SDK | ‚≠ê‚≠ê‚≠ê |
| `pydantic` | 2.0+ | üìä „Éá„Éº„ÇøÊ§úË®º | ‚≠ê‚≠ê |
| `requests` | ÊúÄÊñ∞ | üåê Â§ñÈÉ®APIÈÄö‰ø° | ‚≠ê‚≠ê |
| `python-dotenv` | ÊúÄÊñ∞ | üîë Áí∞Â¢ÉÂ§âÊï∞ÁÆ°ÁêÜ | ‚≠ê |

### üí¨ ‰ºöË©±Áä∂ÊÖãÁÆ°ÁêÜ‰ªïÊßò

#### üìã „É°„ÉÉ„Çª„Éº„Ç∏ÊßãÈÄ†

```python
class Message:
    role: str  # "user" or "assistant"
    content: str
    timestamp: datetime
    metadata: dict  # Additional context

class ConversationState:
    messages: List[Message]
    context_window: int = 10  # Max messages to keep
    total_tokens: int = 0
    session_id: str
```

#### üîÑ „Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàÁÆ°ÁêÜÊà¶Áï•

```python
def build_context(history: List[Message], max_tokens: int = 4000):
    # 1. ÊúÄÊñ∞„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÑ™ÂÖà
    context = []
    token_count = 0
    
    for msg in reversed(history):
        msg_tokens = count_tokens(msg.content)
        if token_count + msg_tokens > max_tokens:
            break
        context.insert(0, msg)
        token_count += msg_tokens
    
    return context
```

### üîß „ÉÑ„Éº„É´‰ΩøÁî®‰ªïÊßò

#### üìã „ÉÑ„Éº„É´ÂÆöÁæ©„Éï„Ç©„Éº„Éû„ÉÉ„Éà

```json
{
    "name": "tool_name",
    "description": "Tool description",
    "input_schema": {
        "type": "object",
        "properties": {
            "param1": {
                "type": "string",
                "description": "Parameter description"
            }
        },
        "required": ["param1"]
    }
}
```

#### üîå „ÉÑ„Éº„É´ÂÆüË°å„Éë„Çø„Éº„É≥

```python
def execute_tool(tool_name: str, arguments: dict):
    tool_registry = {
        "get_weather": get_weather_function,
        "search_web": search_web_function,
        "calculate": calculate_function
    }
    
    if tool_name in tool_registry:
        tool_func = tool_registry[tool_name]
        try:
            result = tool_func(**arguments)
            return {"success": True, "result": result}
        except Exception as e:
            return {"success": False, "error": str(e)}
    
    return {"success": False, "error": "Tool not found"}
```

### üå§Ô∏è Â§ñÈÉ®APIÁµ±Âêà

#### üìã Open-Meteo Weather API

```python
WEATHER_API_CONFIG = {
    "base_url": "https://api.open-meteo.com/v1/forecast",
    "params": {
        "current_weather": True,
        "hourly": ["temperature_2m", "precipitation"],
        "daily": ["temperature_2m_max", "temperature_2m_min"],
        "timezone": "auto"
    }
}

def fetch_weather(latitude: float, longitude: float):
    params = {
        "latitude": latitude,
        "longitude": longitude,
        **WEATHER_API_CONFIG["params"]
    }
    response = requests.get(
        WEATHER_API_CONFIG["base_url"],
        params=params
    )
    return response.json()
```

---

## üö® „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞

### üìÑ „Ç®„É©„ÉºÂàÜÈ°û

| „Ç®„É©„ÉºÁ®ÆÂà• | ÂéüÂõ† | ÂØæÂá¶Ê≥ï | ÂΩ±ÈüøÂ∫¶ |
|-----------|------|--------|---------|
| **Â±•Ê≠¥Ë∂ÖÈÅé„Ç®„É©„Éº** | üìù ‰ºöË©±Â±•Ê≠¥„ÅåÈï∑„Åô„Åé„Çã | Âè§„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏ÂâäÈô§ | üü° ‰∏≠ |
| **„ÉÑ„Éº„É´ÂÆüË°å„Ç®„É©„Éº** | üîß „ÉÑ„Éº„É´Âá¶ÁêÜÂ§±Êïó | „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂøúÁ≠î | üü° ‰∏≠ |
| **APIÂëº„Å≥Âá∫„Åó„Ç®„É©„Éº** | üåê Â§ñÈÉ®APIÂ§±Êïó | „É™„Éà„É©„Ç§„Éª„Ç≠„É£„ÉÉ„Ç∑„É•‰ΩøÁî® | üü° ‰∏≠ |
| **ÂºïÊï∞Ê§úË®º„Ç®„É©„Éº** | üìä ‰∏çÊ≠£„Å™„ÉÑ„Éº„É´ÂºïÊï∞ | „Éá„Éï„Ç©„É´„ÉàÂÄ§‰ΩøÁî® | üü† ‰Ωé |
| **„Çª„ÉÉ„Ç∑„Éß„É≥„Ç®„É©„Éº** | üíæ Áä∂ÊÖã‰øùÂ≠òÂ§±Êïó | „Çª„ÉÉ„Ç∑„Éß„É≥„É™„Çª„ÉÉ„Éà | üî¥ È´ò |

### üõ†Ô∏è „Ç®„É©„ÉºÂá¶ÁêÜÊà¶Áï•

```python
def safe_tool_execution(tool_call):
    try:
        # ÂºïÊï∞Ê§úË®º
        validated_args = validate_tool_arguments(
            tool_call.name,
            tool_call.arguments
        )
    except ValidationError as e:
        return create_error_response(
            f"ÂºïÊï∞Ê§úË®º„Ç®„É©„Éº: {e}",
            fallback=True
        )
    
    try:
        # „ÉÑ„Éº„É´ÂÆüË°å
        result = execute_tool(tool_call.name, validated_args)
    except ToolExecutionError as e:
        # „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂá¶ÁêÜ
        return create_fallback_response(tool_call.name)
    except Exception as e:
        # ‰∏ÄËà¨„Ç®„É©„Éº
        logger.error(f"Tool execution failed: {e}")
        return create_error_response(str(e))
    
    return format_tool_result(result)
```

### üé® „Ç®„É©„ÉºË°®Á§∫„Éë„Çø„Éº„É≥

```python
# ‰ºöË©±Áä∂ÊÖã„Ç®„É©„Éº
if error_type == "history_overflow":
    st.warning("‚ö†Ô∏è ‰ºöË©±Â±•Ê≠¥„ÅåÂà∂Èôê„ÇíË∂Ö„Åà„Åæ„Åó„Åü")
    if st.button("Âè§„ÅÑÂ±•Ê≠¥„Çí„ÇØ„É™„Ç¢"):
        clear_old_history()
        st.success("‚úÖ Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü")

# „ÉÑ„Éº„É´„Ç®„É©„Éº
elif error_type == "tool_execution":
    st.error("‚ùå „ÉÑ„Éº„É´ÂÆüË°å„Ç®„É©„Éº")
    with st.expander("„Ç®„É©„ÉºË©≥Á¥∞"):
        st.code(error_details)
    st.info("üí° Âà•„ÅÆÊñπÊ≥ï„ÅßÂõûÁ≠î„ÇíÁîüÊàê„Åó„Åæ„Åô...")
```

### üîÑ „Ç®„É©„ÉºÂæ©Êóß„Éï„É≠„Éº

```mermaid
graph TD
    A["Operation Start"] --> B{Operation Type}
    
    B -->|Conversation| C["Check History"]
    C --> D{"History Valid?"}
    D -->|No| E["Reset History"]
    D -->|Yes| F["Continue"]
    
    B -->|Tool| G["Validate Tool"]
    G --> H{"Tool Valid?"}
    H -->|No| I["Use Fallback"]
    H -->|Yes| J["Execute Tool"]
    
    B -->|Function| K["Check API"]
    K --> L{"API Available?"}
    L -->|No| M["Use Cache/Mock"]
    L -->|Yes| N["Call API"]
    
    E --> F
    I --> O["Generate Response"]
    J --> O
    M --> O
    N --> O
    
    O --> P["Display Result"]
```

---

## üéâ „Åæ„Å®„ÇÅ

„Åì„ÅÆË®≠Ë®àÊõ∏„ÅØ„ÄÅ**a05_conversation_state.py** „ÅÆÂåÖÊã¨ÁöÑ„Å™ÊäÄË°ì‰ªïÊßò„Å®ÂÆüË£ÖË©≥Á¥∞„ÇíÁ∂≤ÁæÖ„Åó„ÅüÂÆåÂÖ®„Éâ„Ç≠„É•„É°„É≥„Éà„Åß„Åô„ÄÇ

### üåü Ë®≠Ë®à„ÅÆ„Éè„Ç§„É©„Ç§„Éà

- **üí¨ Áä∂ÊÖãÁÆ°ÁêÜ**: ‰ºöË©±Â±•Ê≠¥„ÅÆÂäπÁéáÁöÑ„Å™ÁÆ°ÁêÜ„Å®ÊñáËÑà‰øùÊåÅ
- **üîß „ÉÑ„Éº„É´Áµ±Âêà**: ÊüîËªü„Å™„ÉÑ„Éº„É´ÂÆöÁæ©„Å®ÂÆüË°å„Éï„É¨„Éº„É†„ÉØ„Éº„ÇØ
- **üå§Ô∏è APIÈÄ£Êê∫**: Â§ñÈÉ®„Çµ„Éº„Éì„Çπ„Å®„ÅÆ„Ç∑„Éº„É†„É¨„Çπ„Å™Áµ±Âêà
- **üìä ÂûãÂÆâÂÖ®ÊÄß**: Pydantic„Å´„Çà„ÇãÂºïÊï∞Ê§úË®º
- **üõ°Ô∏è Â†ÖÁâ¢ÊÄß**: ÂåÖÊã¨ÁöÑ„Å™„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞

### üîß „Ç¢„Éº„Ç≠„ÉÜ„ÇØ„ÉÅ„É£ÁâπÂæ¥

- **üì¶ „É¢„Ç∏„É•„Éº„É´Ë®≠Ë®à**: Ê©üËÉΩÂà•„ÅÆÁã¨Á´ã„Åó„ÅüÂÆüË£Ö
- **üîÑ Êã°ÂºµÊÄß**: Êñ∞Ë¶è„ÉÑ„Éº„É´„ÉªÈñ¢Êï∞„ÅÆÂÆπÊòì„Å™ËøΩÂä†
- **üíæ Ê∞∏Á∂öÊÄß**: „Çª„ÉÉ„Ç∑„Éß„É≥Ë∑®„Åé„ÅÆÁä∂ÊÖã‰øùÊåÅ
- **üé® UXÊúÄÈÅ©Âåñ**: Áõ¥ÊÑüÁöÑ„Å™‰ºöË©±„Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ